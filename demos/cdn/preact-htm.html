<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Yetzirah + Preact + HTM Demo</title>

  <!-- Tachyons CSS from CDN -->
  <link rel="stylesheet" href="https://unpkg.com/tachyons@4/css/tachyons.min.css">

  <!-- Demo-specific styles -->
  <link rel="stylesheet" href="styles.css">

  <!-- Yetzirah button interaction styles (hover/click feedback) -->
  <link rel="stylesheet" href="../../packages/core/button.css">

  <style>
    /* Additional styles for Preact demo */
    .preact-app {
      min-height: 100vh;
    }
    .counter-display {
      font-size: 3rem;
      font-weight: bold;
      font-variant-numeric: tabular-nums;
    }
    .todo-item {
      transition: opacity 0.2s, transform 0.2s;
    }
    .todo-item.completed {
      opacity: 0.6;
      text-decoration: line-through;
    }
    .fruit-badge {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      background: #e3f2fd;
      border-radius: 4px;
      font-size: 0.875rem;
    }
    .dark-mode .fruit-badge {
      background: #1565c0;
    }
  </style>
</head>
<body class="sans-serif">
  <div id="app">
    <!-- Loading state before Preact hydrates -->
    <div class="pa5 tc gray">Loading Preact + HTM demo...</div>
  </div>

  <!-- Code examples as script templates to avoid escaping issues -->
  <script type="text/template" id="code-importmap"><!-- Add to your HTML (once @grimoire/yetzirah-core is published to npm) -->
&lt;script type="importmap"&gt;
{
  "imports": {
    "preact": "https://esm.sh/preact@10",
    "preact/": "https://esm.sh/preact@10/",
    "htm/preact": "https://esm.sh/htm/preact?external=preact",
    "yetzirah": "https://cdn.jsdelivr.net/npm/@grimoire/yetzirah-core/cdn/core.js"
  }
}
&lt;/script&gt;
&lt;script type="module"&gt;
  import 'yetzirah';  // Load all components
&lt;/script&gt;</script>

  <script type="text/template" id="code-event-hook">// Custom hook for Yetzirah events
function useYetzirahEvent(ref, eventName, handler) {
  useEffect(() => {
    const element = ref.current;
    if (!element || !handler) return;

    element.addEventListener(eventName, handler);
    return () => element.removeEventListener(eventName, handler);
  }, [ref, eventName, handler]);
}

// Usage
const dialogRef = useRef(null);
useYetzirahEvent(dialogRef, 'close', () => {
  console.log('Dialog closed!');
});</script>

  <script type="text/template" id="code-controlling">// Use refs to call component methods
const dialogRef = useRef(null);

const openDialog = () => dialogRef.current?.showModal();
const closeDialog = () => dialogRef.current?.close();

return html`
  &lt;ytz-dialog ref=${dialogRef}&gt;
    &lt;div class="dialog-content"&gt;...&lt;/div&gt;
  &lt;/ytz-dialog&gt;
`;</script>

  <script type="text/template" id="code-htm-syntax">import { html } from 'htm/preact';

// HTM looks like JSX but uses template literals
const element = html`
  &lt;div class="container"&gt;
    &lt;${MyComponent} prop=${value}&gt;
      ${items.map(item => html`&lt;li&gt;${item}&lt;/li&gt;`)}
    &lt;/${MyComponent}&gt;
  &lt;/div&gt;
`;</script>

  <!--
    Preact + HTM + Yetzirah from CDN

    This demo shows how to use Yetzirah components with Preact and HTM
    for a React-like developer experience without any build step.

    HTM (Hyperscript Tagged Markup) provides JSX-like syntax using
    tagged template literals - no transpilation needed!
  -->

  <!-- Import Map for cleaner imports -->
  <script type="importmap">
  {
    "imports": {
      "preact": "https://esm.sh/preact@10.19.3",
      "preact/": "https://esm.sh/preact@10.19.3/",
      "htm": "https://esm.sh/htm@3.1.1",
      "htm/preact": "https://esm.sh/htm@3.1.1/preact?external=preact"
    }
  }
  </script>

  <script type="module">
    // Import Preact hooks and HTM
    import { render } from 'preact';
    import { useState, useEffect, useRef, useCallback } from 'preact/hooks';
    import { html } from 'htm/preact';

    // Load Yetzirah components (local path for development)
    import '../../packages/core/cdn/core.js';

    // Helper to get code from template scripts
    const getCodeTemplate = (id) => document.getElementById(id)?.textContent || '';

    // ===========================================
    // Utility: useYetzirahEvent hook
    // ===========================================
    // Custom hook for handling Yetzirah custom element events
    function useYetzirahEvent(ref, eventName, handler) {
      useEffect(() => {
        const element = ref.current;
        if (!element || !handler) return;

        element.addEventListener(eventName, handler);
        return () => element.removeEventListener(eventName, handler);
      }, [ref, eventName, handler]);
    }

    // ===========================================
    // Counter Example - Basic State
    // ===========================================
    function Counter() {
      const [count, setCount] = useState(0);

      return html`
        <section class="demo-section mb5 pb4 bb b--light-gray">
          <h2 class="f3 fw6 mb3">Counter with Preact State</h2>
          <p class="f5 lh-copy gray mb3">
            Using Preact's useState hook with Yetzirah buttons.
          </p>

          <div class="flex items-center gap3 mb3">
            <ytz-button
              class="ph3 pv2 br2 bn white bg-blue pointer"
              onClick=${() => setCount(c => c - 1)}
            >
              - Decrease
            </ytz-button>

            <span class="counter-display ph3">${count}</span>

            <ytz-button
              class="ph3 pv2 br2 bn white bg-blue pointer"
              onClick=${() => setCount(c => c + 1)}
            >
              + Increase
            </ytz-button>
          </div>

          <ytz-button
            class="ph3 pv2 br2 ba b--gray gray bg-transparent pointer"
            onClick=${() => setCount(0)}
          >
            Reset
          </ytz-button>
        </section>
      `;
    }

    // ===========================================
    // Dialog Example - Refs and Events
    // ===========================================
    function DialogExample() {
      const dialogRef = useRef(null);
      const [lastAction, setLastAction] = useState('None');

      const openDialog = useCallback(() => {
        dialogRef.current?.showModal();
      }, []);

      const closeDialog = useCallback(() => {
        dialogRef.current?.close();
      }, []);

      // Handle dialog close event
      useYetzirahEvent(dialogRef, 'close', () => {
        setLastAction('Dialog closed');
      });

      return html`
        <section class="demo-section mb5 pb4 bb b--light-gray">
          <h2 class="f3 fw6 mb3">Dialog with Events</h2>
          <p class="f5 lh-copy gray mb3">
            Using refs to control dialogs and listening to custom events.
          </p>

          <div class="flex items-center gap3 mb3">
            <ytz-button
              class="ph3 pv2 br2 bn white bg-purple pointer"
              onClick=${openDialog}
            >
              Open Dialog
            </ytz-button>
            <span class="f6 gray">Last action: ${lastAction}</span>
          </div>

          <ytz-dialog ref=${dialogRef}>
            <div class="dialog-content pa4 bg-white br3 shadow-2 mw6">
              <h3 class="f4 fw6 mt0 mb3">Hello from Preact!</h3>
              <p class="lh-copy mb3">
                This dialog is controlled via a Preact ref.
                Click the backdrop, press Escape, or use the button to close.
              </p>
              <div class="flex justify-end gap2">
                <ytz-button
                  class="ph3 pv2 br2 ba b--gray gray bg-transparent pointer"
                  onClick=${closeDialog}
                >
                  Cancel
                </ytz-button>
                <ytz-button
                  class="ph3 pv2 br2 bn white bg-purple pointer"
                  onClick=${() => {
                    setLastAction('Confirmed!');
                    closeDialog();
                  }}
                >
                  Confirm
                </ytz-button>
              </div>
            </div>
          </ytz-dialog>
        </section>
      `;
    }

    // ===========================================
    // Autocomplete Example - Change Events
    // ===========================================
    function AutocompleteExample() {
      const autocompleteRef = useRef(null);
      const [selectedFruit, setSelectedFruit] = useState(null);

      const fruits = [
        { value: 'apple', label: 'Apple', emoji: 'üçé' },
        { value: 'banana', label: 'Banana', emoji: 'üçå' },
        { value: 'cherry', label: 'Cherry', emoji: 'üçí' },
        { value: 'date', label: 'Date', emoji: 'üå¥' },
        { value: 'elderberry', label: 'Elderberry', emoji: 'ü´ê' },
        { value: 'fig', label: 'Fig', emoji: 'üçá' },
        { value: 'grape', label: 'Grape', emoji: 'üçá' },
        { value: 'honeydew', label: 'Honeydew', emoji: 'üçà' },
      ];

      // Handle autocomplete change event
      useYetzirahEvent(autocompleteRef, 'change', (e) => {
        const fruit = fruits.find(f => f.value === e.detail.value);
        setSelectedFruit(fruit);
      });

      return html`
        <section class="demo-section mb5 pb4 bb b--light-gray">
          <h2 class="f3 fw6 mb3">Autocomplete with Change Events</h2>
          <p class="f5 lh-copy gray mb3">
            Listening to the change event and updating Preact state.
          </p>

          <div class="flex items-start gap4">
            <ytz-autocomplete ref=${autocompleteRef} class="dib" style="width: 280px;">
              <input
                slot="input"
                type="text"
                placeholder="Search for a fruit..."
                class="pa2 ba b--light-gray br2 w-100"
              />
              ${fruits.map(fruit => html`
                <ytz-option value=${fruit.value}>
                  ${fruit.emoji} ${fruit.label}
                </ytz-option>
              `)}
            </ytz-autocomplete>

            <div class="pa3 bg-near-white br2 flex-grow-1">
              ${selectedFruit ? html`
                <p class="ma0 mb2 f6 gray">Selected:</p>
                <p class="ma0 f4">
                  <span class="fruit-badge">${selectedFruit.emoji} ${selectedFruit.label}</span>
                </p>
              ` : html`
                <p class="ma0 gray f6">No fruit selected</p>
              `}
            </div>
          </div>
        </section>
      `;
    }

    // ===========================================
    // Tabs Example - Controlled Component
    // ===========================================
    function TabsExample() {
      const [activeTab, setActiveTab] = useState('hooks');
      const tabsRef = useRef(null);

      useYetzirahEvent(tabsRef, 'change', (e) => {
        setActiveTab(e.detail.value);
      });

      const tabs = [
        { id: 'hooks', label: 'Hooks', icon: 'ü™ù' },
        { id: 'state', label: 'State', icon: 'üì¶' },
        { id: 'refs', label: 'Refs', icon: 'üéØ' },
      ];

      const content = {
        hooks: html`
          <p class="mt0">Preact provides the same hooks API as React:</p>
          <ul class="pl3">
            <li><code>useState</code> - Manage component state</li>
            <li><code>useEffect</code> - Side effects and cleanup</li>
            <li><code>useRef</code> - DOM references</li>
            <li><code>useCallback</code> - Memoized callbacks</li>
            <li><code>useMemo</code> - Memoized values</li>
          </ul>
        `,
        state: html`
          <p class="mt0">State management patterns with Yetzirah:</p>
          <ul class="pl3">
            <li>Use <code>useState</code> for local component state</li>
            <li>Listen to Yetzirah events to sync state</li>
            <li>Use refs to call component methods</li>
            <li>Preact Context works for shared state</li>
          </ul>
        `,
        refs: html`
          <p class="mt0">Working with refs and Yetzirah:</p>
          <ul class="pl3">
            <li>Use <code>useRef</code> to get element references</li>
            <li>Call methods like <code>showModal()</code>, <code>close()</code></li>
            <li>Add event listeners in <code>useEffect</code></li>
            <li>Clean up listeners on unmount</li>
          </ul>
        `,
      };

      return html`
        <section class="demo-section mb5 pb4 bb b--light-gray">
          <h2 class="f3 fw6 mb3">Controlled Tabs</h2>
          <p class="f5 lh-copy gray mb3">
            Syncing tab state between Yetzirah and Preact.
          </p>

          <ytz-tabs ref=${tabsRef} value=${activeTab} class="mb3">
            <div class="flex bb b--light-gray" role="tablist">
              ${tabs.map(tab => html`
                <ytz-tab
                  panel=${tab.id}
                  class="pa3 bg-transparent bn pointer bb bw2 b--transparent hover-b--blue"
                >
                  ${tab.icon} ${tab.label}
                </ytz-tab>
              `)}
            </div>
            ${tabs.map(tab => html`
              <ytz-tabpanel id=${tab.id} class="pa3 bg-near-white br2 br--bottom">
                ${content[tab.id]}
              </ytz-tabpanel>
            `)}
          </ytz-tabs>

          <div class="flex gap2">
            ${tabs.map(tab => html`
              <ytz-button
                class=${`ph2 pv1 br2 bn pointer f6 ${
                  activeTab === tab.id
                    ? 'white bg-blue'
                    : 'gray bg-light-gray'
                }`}
                onClick=${() => setActiveTab(tab.id)}
              >
                ${tab.label}
              </ytz-button>
            `)}
          </div>
          <p class="f6 gray mt2">
            Click buttons above to control tabs programmatically
          </p>
        </section>
      `;
    }

    // ===========================================
    // Todo App Example - Complex State
    // ===========================================
    function TodoApp() {
      const [todos, setTodos] = useState([
        { id: 1, text: 'Learn Preact + HTM', completed: true },
        { id: 2, text: 'Try Yetzirah components', completed: false },
        { id: 3, text: 'Build something awesome', completed: false },
      ]);
      const [filter, setFilter] = useState('all');
      const inputRef = useRef(null);
      const dialogRef = useRef(null);
      const selectRef = useRef(null);

      const addTodo = useCallback((text) => {
        if (!text.trim()) return;
        setTodos(prev => [...prev, {
          id: Date.now(),
          text: text.trim(),
          completed: false,
        }]);
      }, []);

      const toggleTodo = useCallback((id) => {
        setTodos(prev => prev.map(todo =>
          todo.id === id ? { ...todo, completed: !todo.completed } : todo
        ));
      }, []);

      const deleteTodo = useCallback((id) => {
        setTodos(prev => prev.filter(todo => todo.id !== id));
      }, []);

      const handleSubmit = useCallback((e) => {
        e.preventDefault();
        const input = inputRef.current;
        if (input) {
          addTodo(input.value);
          input.value = '';
        }
      }, [addTodo]);

      // Listen for select changes
      useYetzirahEvent(selectRef, 'change', (e) => {
        setFilter(e.detail.value);
      });

      const filteredTodos = todos.filter(todo => {
        if (filter === 'active') return !todo.completed;
        if (filter === 'completed') return todo.completed;
        return true;
      });

      const stats = {
        total: todos.length,
        completed: todos.filter(t => t.completed).length,
        active: todos.filter(t => !t.completed).length,
      };

      return html`
        <section class="demo-section mb5 pb4 bb b--light-gray">
          <h2 class="f3 fw6 mb3">Todo App with Complex State</h2>
          <p class="f5 lh-copy gray mb3">
            A complete todo app using Preact state with Yetzirah components.
          </p>

          <div class="flex gap4 flex-wrap">
            <!-- Todo List -->
            <div class="flex-grow-1" style="min-width: 300px;">
              <form onSubmit=${handleSubmit} class="flex gap2 mb3">
                <input
                  ref=${inputRef}
                  type="text"
                  placeholder="What needs to be done?"
                  class="pa2 ba b--light-gray br2 flex-grow-1"
                />
                <ytz-button
                  type="submit"
                  class="ph3 pv2 br2 bn white bg-green pointer"
                >
                  Add
                </ytz-button>
              </form>

              <div class="flex items-center gap3 mb3">
                <span class="f6 gray">Filter:</span>
                <ytz-select ref=${selectRef} value=${filter} class="dib" style="min-width: 120px;">
                  <ytz-option value="all">All (${stats.total})</ytz-option>
                  <ytz-option value="active">Active (${stats.active})</ytz-option>
                  <ytz-option value="completed">Completed (${stats.completed})</ytz-option>
                </ytz-select>
              </div>

              <ul class="list pl0 ma0">
                ${filteredTodos.map(todo => html`
                  <li
                    key=${todo.id}
                    class=${`todo-item flex items-center gap2 pa2 bb b--light-gray ${
                      todo.completed ? 'completed' : ''
                    }`}
                  >
                    <ytz-toggle
                      checked=${todo.completed}
                      class="toggle-demo"
                      onClick=${() => toggleTodo(todo.id)}
                      aria-label=${todo.completed ? 'Mark incomplete' : 'Mark complete'}
                    />
                    <span class="flex-grow-1">${todo.text}</span>
                    <ytz-button
                      class="ph2 pv1 br2 bn bg-transparent dark-red pointer f6"
                      onClick=${() => deleteTodo(todo.id)}
                    >
                      Delete
                    </ytz-button>
                  </li>
                `)}
                ${filteredTodos.length === 0 && html`
                  <li class="pa3 tc gray">No todos to show</li>
                `}
              </ul>
            </div>

            <!-- Stats Card -->
            <div class="pa3 bg-near-white br2" style="min-width: 200px;">
              <h4 class="f5 fw6 mt0 mb3">Statistics</h4>
              <dl class="ma0">
                <div class="flex justify-between mb2">
                  <dt class="gray">Total:</dt>
                  <dd class="ma0 fw6">${stats.total}</dd>
                </div>
                <div class="flex justify-between mb2">
                  <dt class="gray">Active:</dt>
                  <dd class="ma0 fw6 blue">${stats.active}</dd>
                </div>
                <div class="flex justify-between">
                  <dt class="gray">Completed:</dt>
                  <dd class="ma0 fw6 green">${stats.completed}</dd>
                </div>
              </dl>
            </div>
          </div>
        </section>
      `;
    }

    // ===========================================
    // Drawer Navigation Example
    // ===========================================
    function DrawerExample() {
      const drawerRef = useRef(null);
      const [currentPage, setCurrentPage] = useState('home');

      const pages = [
        { id: 'home', label: 'Home', icon: 'üè†' },
        { id: 'about', label: 'About', icon: '‚ÑπÔ∏è' },
        { id: 'contact', label: 'Contact', icon: 'üìß' },
      ];

      const openDrawer = useCallback(() => {
        drawerRef.current?.show();
      }, []);

      const navigateTo = useCallback((pageId) => {
        setCurrentPage(pageId);
        drawerRef.current?.close();
      }, []);

      return html`
        <section class="demo-section mb5 pb4 bb b--light-gray">
          <h2 class="f3 fw6 mb3">Drawer Navigation</h2>
          <p class="f5 lh-copy gray mb3">
            Mobile-style navigation using a drawer controlled by Preact.
          </p>

          <div class="flex items-center gap3 mb3">
            <ytz-button
              class="ph3 pv2 br2 bn white bg-dark-blue pointer"
              onClick=${openDrawer}
            >
              Open Menu
            </ytz-button>
            <span class="f6 gray">
              Current page: <strong>${pages.find(p => p.id === currentPage)?.label}</strong>
            </span>
          </div>

          <ytz-drawer ref=${drawerRef} anchor="left">
            <div class="drawer-content h-100 w5 bg-white pa4">
              <h3 class="f5 fw6 mt0 mb4">Navigation</h3>
              <nav class="flex flex-column gap2">
                ${pages.map(page => html`
                  <ytz-button
                    class=${`pa2 br2 bn pointer tl ${
                      currentPage === page.id
                        ? 'white bg-blue'
                        : 'gray bg-light-gray'
                    }`}
                    onClick=${() => navigateTo(page.id)}
                  >
                    ${page.icon} ${page.label}
                  </ytz-button>
                `)}
              </nav>
            </div>
          </ytz-drawer>

          <!-- Page Content -->
          <div class="pa3 bg-near-white br2">
            ${currentPage === 'home' && html`
              <h4 class="mt0">üè† Welcome Home</h4>
              <p class="mb0">This is the home page content.</p>
            `}
            ${currentPage === 'about' && html`
              <h4 class="mt0">‚ÑπÔ∏è About Us</h4>
              <p class="mb0">Learn more about our project.</p>
            `}
            ${currentPage === 'contact' && html`
              <h4 class="mt0">üìß Contact</h4>
              <p class="mb0">Get in touch with our team.</p>
            `}
          </div>
        </section>
      `;
    }

    // ===========================================
    // Code Examples Component
    // ===========================================
    function CodeExamples() {
      return html`
        <section class="demo-section mb5">
          <h2 class="f3 fw6 mb3">Code Patterns</h2>

          <div class="bg-near-white pa3 br2 mb4">
            <h4 class="f6 fw6 mt0 mb2">Event Handling Hook</h4>
            <pre class="code-block f6 overflow-x-auto"><code>${getCodeTemplate('code-event-hook')}</code></pre>
          </div>

          <div class="bg-near-white pa3 br2 mb4">
            <h4 class="f6 fw6 mt0 mb2">Controlling Components</h4>
            <pre class="code-block f6 overflow-x-auto"><code>${getCodeTemplate('code-controlling')}</code></pre>
          </div>

          <div class="bg-near-white pa3 br2">
            <h4 class="f6 fw6 mt0 mb2">HTM Syntax Basics</h4>
            <pre class="code-block f6 overflow-x-auto"><code>${getCodeTemplate('code-htm-syntax')}</code></pre>
          </div>
        </section>
      `;
    }

    // ===========================================
    // Main App Component
    // ===========================================
    function App() {
      return html`
        <div class="preact-app">
          <header class="pa4 bg-dark-pink white">
            <div class="mw8 center">
              <nav class="mb3">
                <a href="../index.html" class="link light-pink">‚Üê All Demos</a>
                <span class="mh2 light-pink">|</span>
                <a href="index.html" class="link light-pink">CDN Demo</a>
                <span class="mh2 light-pink">|</span>
                <a href="importmap.html" class="link light-pink">Import Map Demo</a>
              </nav>
              <h1 class="f2 fw6 mb2 mt0">Preact + HTM + Yetzirah</h1>
              <p class="f5 lh-copy light-pink mt0 mb0">
                React-like DX without a build step. All loaded from CDN!
              </p>
            </div>
          </header>

          <main class="pa4 mw8 center">
            <!-- Overview -->
            <section class="demo-section mb5 pb4 bb b--light-gray">
              <h2 class="f3 fw6 mb3">About This Demo</h2>
              <p class="f5 lh-copy gray mb3">
                This page demonstrates using <strong>Yetzirah</strong> web components
                with <strong>Preact</strong> and <strong>HTM</strong> for a React-like
                developer experience - all without any build step!
              </p>

              <div class="bg-near-white pa3 br2 mb3">
                <h4 class="f6 fw6 mt0 mb2">Key Technologies:</h4>
                <ul class="ma0 pl3">
                  <li><strong>Preact</strong> - 3KB alternative to React with the same API</li>
                  <li><strong>HTM</strong> - JSX-like syntax using tagged template literals</li>
                  <li><strong>Yetzirah</strong> - Headless web components</li>
                </ul>
              </div>

              <pre class="code-block f6 overflow-x-auto"><code>${getCodeTemplate('code-importmap')}</code></pre>
            </section>

            <${Counter} />
            <${DialogExample} />
            <${AutocompleteExample} />
            <${TabsExample} />
            <${TodoApp} />
            <${DrawerExample} />
            <${CodeExamples} />
          </main>

          <footer class="pa4 bg-near-white bt b--light-gray">
            <div class="mw8 center">
              <p class="f6 gray ma0">
                Yetzirah - Preact + HTM Demo |
                <a href="../index.html" class="link blue">All Demos</a> |
                <a href="index.html" class="link blue">CDN Demo</a> |
                <a href="https://preactjs.com" class="link blue" target="_blank">Preact</a> |
                <a href="https://github.com/developit/htm" class="link blue" target="_blank">HTM</a>
              </p>
            </div>
          </footer>
        </div>
      `;
    }

    // Mount the app
    render(html`<${App} />`, document.getElementById('app'));
    console.log('Preact + HTM + Yetzirah demo loaded');
  </script>
</body>
</html>
