<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Yetzirah Vanilla JS Task Manager</title>

  <!-- Tachyons CSS from CDN -->
  <link rel="stylesheet" href="https://unpkg.com/tachyons@4/css/tachyons.min.css">

  <!-- Demo-specific styles -->
  <link rel="stylesheet" href="styles.css">

  <style>
    /* App-specific styles */
    .task-item {
      transition: opacity 0.2s, background-color 0.2s;
    }
    .task-item.completed {
      opacity: 0.6;
    }
    .task-item.completed .task-text {
      text-decoration: line-through;
    }
    .task-item:hover {
      background-color: #f8f9fa;
    }
    .priority-high { border-left: 3px solid #e53e3e; }
    .priority-medium { border-left: 3px solid #dd6b20; }
    .priority-low { border-left: 3px solid #38a169; }

    .stats-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .category-badge {
      display: inline-block;
      padding: 0.125rem 0.5rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    .category-work { background: #e3f2fd; color: #1565c0; }
    .category-personal { background: #fce4ec; color: #c2185b; }
    .category-shopping { background: #e8f5e9; color: #2e7d32; }
    .category-health { background: #fff3e0; color: #ef6c00; }

    .empty-state {
      padding: 3rem;
      text-align: center;
      color: #718096;
    }

    /* Dark mode support */
    .dark-mode .task-item:hover {
      background-color: #2d3748;
    }
  </style>
</head>
<body class="sans-serif bg-near-white min-vh-100">
  <!-- Navigation Drawer -->
  <ytz-drawer id="nav-drawer" anchor="left">
    <div class="drawer-content h-100 w5 bg-white pa4 flex flex-column">
      <h2 class="f4 fw6 mt0 mb4">Task Manager</h2>

      <nav class="flex-grow-1">
        <a href="#" class="db pa2 mb2 br2 link dark-gray hover-bg-light-gray" data-view="all">
          All Tasks
        </a>
        <a href="#" class="db pa2 mb2 br2 link dark-gray hover-bg-light-gray" data-view="active">
          Active
        </a>
        <a href="#" class="db pa2 mb2 br2 link dark-gray hover-bg-light-gray" data-view="completed">
          Completed
        </a>
        <hr class="mv3 b--light-gray">
        <a href="#" class="db pa2 mb2 br2 link dark-gray hover-bg-light-gray" data-category="work">
          Work
        </a>
        <a href="#" class="db pa2 mb2 br2 link dark-gray hover-bg-light-gray" data-category="personal">
          Personal
        </a>
        <a href="#" class="db pa2 mb2 br2 link dark-gray hover-bg-light-gray" data-category="shopping">
          Shopping
        </a>
        <a href="#" class="db pa2 mb2 br2 link dark-gray hover-bg-light-gray" data-category="health">
          Health
        </a>
      </nav>

      <div class="pt3 bt b--light-gray">
        <div class="flex items-center justify-between">
          <span class="f6 gray">Dark Mode</span>
          <ytz-theme-toggle id="theme-toggle"></ytz-theme-toggle>
        </div>
      </div>
    </div>
  </ytz-drawer>

  <!-- Main App Container -->
  <div class="mw8 center pa4">
    <!-- Header -->
    <header class="flex items-center justify-between mb4">
      <div class="flex items-center gap3">
        <button
          onclick="document.getElementById('nav-drawer').show()"
          class="pa2 bg-transparent bn pointer br2 hover-bg-light-gray"
          aria-label="Open navigation"
        >
          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
          </svg>
        </button>
        <h1 class="f3 fw6 ma0">Task Manager</h1>
      </div>

      <div class="flex items-center gap3">
        <!-- Search -->
        <ytz-autocomplete id="task-search" class="dn db-ns" style="width: 250px;">
          <input
            slot="input"
            type="text"
            placeholder="Search tasks..."
            class="pa2 ba b--light-gray br2 w-100"
          >
        </ytz-autocomplete>

        <!-- Add Task Button -->
        <button
          onclick="document.getElementById('add-task-dialog').showModal()"
          class="ph3 pv2 br2 bn white bg-blue pointer flex items-center gap2"
        >
          <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
            <path d="M8 2a.75.75 0 01.75.75v4.5h4.5a.75.75 0 010 1.5h-4.5v4.5a.75.75 0 01-1.5 0v-4.5h-4.5a.75.75 0 010-1.5h4.5v-4.5A.75.75 0 018 2z"/>
          </svg>
          <span class="dn di-ns">Add Task</span>
        </button>
      </div>
    </header>

    <!-- Stats Cards -->
    <div class="flex flex-wrap gap3 mb4" id="stats-section">
      <div class="stats-card pa3 br3 white flex-grow-1" style="min-width: 150px;">
        <p class="f6 o-70 ma0 mb1">Total Tasks</p>
        <p class="f2 fw6 ma0" id="stat-total">0</p>
      </div>
      <div class="pa3 br3 bg-white shadow-1 flex-grow-1" style="min-width: 150px;">
        <p class="f6 gray ma0 mb1">Active</p>
        <p class="f2 fw6 ma0 blue" id="stat-active">0</p>
      </div>
      <div class="pa3 br3 bg-white shadow-1 flex-grow-1" style="min-width: 150px;">
        <p class="f6 gray ma0 mb1">Completed</p>
        <p class="f2 fw6 ma0 green" id="stat-completed">0</p>
      </div>
    </div>

    <!-- Filters -->
    <div class="flex flex-wrap items-center gap3 mb4 pa3 bg-white br3 shadow-1">
      <div class="flex items-center gap2">
        <label class="f6 gray">Filter:</label>
        <ytz-select id="filter-status" value="all" style="min-width: 120px;">
          <ytz-option value="all">All</ytz-option>
          <ytz-option value="active">Active</ytz-option>
          <ytz-option value="completed">Completed</ytz-option>
        </ytz-select>
      </div>

      <div class="flex items-center gap2">
        <label class="f6 gray">Category:</label>
        <ytz-select id="filter-category" value="all" style="min-width: 120px;">
          <ytz-option value="all">All</ytz-option>
          <ytz-option value="work">Work</ytz-option>
          <ytz-option value="personal">Personal</ytz-option>
          <ytz-option value="shopping">Shopping</ytz-option>
          <ytz-option value="health">Health</ytz-option>
        </ytz-select>
      </div>

      <div class="flex items-center gap2">
        <label class="f6 gray">Priority:</label>
        <ytz-select id="filter-priority" value="all" style="min-width: 120px;">
          <ytz-option value="all">All</ytz-option>
          <ytz-option value="high">High</ytz-option>
          <ytz-option value="medium">Medium</ytz-option>
          <ytz-option value="low">Low</ytz-option>
        </ytz-select>
      </div>

      <div class="flex-grow-1"></div>

      <ytz-menu>
        <button slot="trigger" class="pa2 bg-transparent bn pointer br2 hover-bg-light-gray">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
            <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"/>
          </svg>
        </button>
        <ytz-menuitem class="menu-item" value="clear-completed">Clear Completed</ytz-menuitem>
        <ytz-menuitem class="menu-item" value="export">Export Tasks</ytz-menuitem>
        <ytz-menuitem class="menu-item" value="import">Import Tasks</ytz-menuitem>
      </ytz-menu>
    </div>

    <!-- Task List -->
    <div class="bg-white br3 shadow-1 overflow-hidden">
      <ul id="task-list" class="list pa0 ma0">
        <!-- Tasks will be rendered here -->
      </ul>
      <div id="empty-state" class="empty-state dn">
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="mb3 o-50">
          <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
        </svg>
        <p class="f5 mb2">No tasks found</p>
        <p class="f6">Add a new task to get started!</p>
      </div>
    </div>
  </div>

  <!-- Add Task Dialog -->
  <ytz-dialog id="add-task-dialog">
    <div class="dialog-content pa4 bg-white br3 shadow-2" style="width: 400px; max-width: 90vw;">
      <h2 class="f4 fw6 mt0 mb3">Add New Task</h2>

      <form id="add-task-form">
        <div class="mb3">
          <label class="db f6 fw5 mb1">Task Name</label>
          <input
            type="text"
            name="text"
            required
            placeholder="What needs to be done?"
            class="pa2 ba b--light-gray br2 w-100"
          >
        </div>

        <div class="mb3">
          <label class="db f6 fw5 mb1">Category</label>
          <ytz-select id="add-category" value="personal" class="w-100">
            <ytz-option value="work">Work</ytz-option>
            <ytz-option value="personal">Personal</ytz-option>
            <ytz-option value="shopping">Shopping</ytz-option>
            <ytz-option value="health">Health</ytz-option>
          </ytz-select>
        </div>

        <div class="mb3">
          <label class="db f6 fw5 mb1">Priority</label>
          <ytz-select id="add-priority" value="medium" class="w-100">
            <ytz-option value="high">High</ytz-option>
            <ytz-option value="medium">Medium</ytz-option>
            <ytz-option value="low">Low</ytz-option>
          </ytz-select>
        </div>

        <div class="flex justify-end gap2 mt4">
          <button
            type="button"
            onclick="document.getElementById('add-task-dialog').close()"
            class="ph3 pv2 br2 ba b--gray gray bg-white pointer"
          >
            Cancel
          </button>
          <button
            type="submit"
            class="ph3 pv2 br2 bn white bg-blue pointer"
          >
            Add Task
          </button>
        </div>
      </form>
    </div>
  </ytz-dialog>

  <!-- Edit Task Dialog -->
  <ytz-dialog id="edit-task-dialog">
    <div class="dialog-content pa4 bg-white br3 shadow-2" style="width: 400px; max-width: 90vw;">
      <h2 class="f4 fw6 mt0 mb3">Edit Task</h2>

      <form id="edit-task-form">
        <input type="hidden" name="id">

        <div class="mb3">
          <label class="db f6 fw5 mb1">Task Name</label>
          <input
            type="text"
            name="text"
            required
            class="pa2 ba b--light-gray br2 w-100"
          >
        </div>

        <div class="mb3">
          <label class="db f6 fw5 mb1">Category</label>
          <ytz-select id="edit-category" class="w-100">
            <ytz-option value="work">Work</ytz-option>
            <ytz-option value="personal">Personal</ytz-option>
            <ytz-option value="shopping">Shopping</ytz-option>
            <ytz-option value="health">Health</ytz-option>
          </ytz-select>
        </div>

        <div class="mb3">
          <label class="db f6 fw5 mb1">Priority</label>
          <ytz-select id="edit-priority" class="w-100">
            <ytz-option value="high">High</ytz-option>
            <ytz-option value="medium">Medium</ytz-option>
            <ytz-option value="low">Low</ytz-option>
          </ytz-select>
        </div>

        <div class="flex justify-end gap2 mt4">
          <button
            type="button"
            onclick="document.getElementById('edit-task-dialog').close()"
            class="ph3 pv2 br2 ba b--gray gray bg-white pointer"
          >
            Cancel
          </button>
          <button
            type="submit"
            class="ph3 pv2 br2 bn white bg-blue pointer"
          >
            Save Changes
          </button>
        </div>
      </form>
    </div>
  </ytz-dialog>

  <!-- Delete Confirmation Dialog -->
  <ytz-dialog id="delete-confirm-dialog">
    <div class="dialog-content pa4 bg-white br3 shadow-2" style="width: 350px; max-width: 90vw;">
      <h2 class="f4 fw6 mt0 mb3">Delete Task?</h2>
      <p class="lh-copy mb4" id="delete-confirm-message">
        Are you sure you want to delete this task? This action cannot be undone.
      </p>
      <div class="flex justify-end gap2">
        <button
          onclick="document.getElementById('delete-confirm-dialog').close('cancel')"
          class="ph3 pv2 br2 ba b--gray gray bg-white pointer"
        >
          Cancel
        </button>
        <button
          onclick="document.getElementById('delete-confirm-dialog').close('confirm')"
          class="ph3 pv2 br2 bn white bg-dark-red pointer"
        >
          Delete
        </button>
      </div>
    </div>
  </ytz-dialog>

  <!-- Load Yetzirah Components -->
  <script type="module">
    import '../../packages/core/cdn/core.js';

    // ==========================================
    // State Management
    // ==========================================
    const AppState = {
      tasks: JSON.parse(localStorage.getItem('tasks') || '[]'),
      filters: {
        status: 'all',
        category: 'all',
        priority: 'all',
        search: ''
      },

      // Persist state to localStorage
      save() {
        localStorage.setItem('tasks', JSON.stringify(this.tasks));
      },

      // Notify listeners of state changes
      notify() {
        document.dispatchEvent(new CustomEvent('state:change'));
      },

      // CRUD Operations
      addTask(task) {
        this.tasks.push({
          id: Date.now(),
          text: task.text,
          category: task.category || 'personal',
          priority: task.priority || 'medium',
          completed: false,
          createdAt: new Date().toISOString()
        });
        this.save();
        this.notify();
      },

      updateTask(id, updates) {
        const task = this.tasks.find(t => t.id === id);
        if (task) {
          Object.assign(task, updates);
          this.save();
          this.notify();
        }
      },

      deleteTask(id) {
        this.tasks = this.tasks.filter(t => t.id !== id);
        this.save();
        this.notify();
      },

      toggleTask(id) {
        const task = this.tasks.find(t => t.id === id);
        if (task) {
          task.completed = !task.completed;
          this.save();
          this.notify();
        }
      },

      clearCompleted() {
        this.tasks = this.tasks.filter(t => !t.completed);
        this.save();
        this.notify();
      },

      // Filtering
      setFilter(key, value) {
        this.filters[key] = value;
        this.notify();
      },

      getFilteredTasks() {
        return this.tasks.filter(task => {
          // Status filter
          if (this.filters.status === 'active' && task.completed) return false;
          if (this.filters.status === 'completed' && !task.completed) return false;

          // Category filter
          if (this.filters.category !== 'all' && task.category !== this.filters.category) return false;

          // Priority filter
          if (this.filters.priority !== 'all' && task.priority !== this.filters.priority) return false;

          // Search filter
          if (this.filters.search && !task.text.toLowerCase().includes(this.filters.search.toLowerCase())) {
            return false;
          }

          return true;
        });
      },

      // Statistics
      getStats() {
        return {
          total: this.tasks.length,
          active: this.tasks.filter(t => !t.completed).length,
          completed: this.tasks.filter(t => t.completed).length
        };
      }
    };

    // Initialize with sample data if empty
    if (AppState.tasks.length === 0) {
      AppState.tasks = [
        { id: 1, text: 'Review project proposal', category: 'work', priority: 'high', completed: false, createdAt: new Date().toISOString() },
        { id: 2, text: 'Buy groceries', category: 'shopping', priority: 'medium', completed: false, createdAt: new Date().toISOString() },
        { id: 3, text: 'Go for a run', category: 'health', priority: 'low', completed: true, createdAt: new Date().toISOString() },
        { id: 4, text: 'Call mom', category: 'personal', priority: 'medium', completed: false, createdAt: new Date().toISOString() },
      ];
      AppState.save();
    }

    // ==========================================
    // UI Rendering
    // ==========================================
    function renderTaskList() {
      const taskList = document.getElementById('task-list');
      const emptyState = document.getElementById('empty-state');
      const tasks = AppState.getFilteredTasks();

      if (tasks.length === 0) {
        taskList.innerHTML = '';
        emptyState.classList.remove('dn');
        return;
      }

      emptyState.classList.add('dn');

      taskList.innerHTML = tasks.map(task => `
        <li class="task-item flex items-center gap3 pa3 bb b--light-gray priority-${task.priority} ${task.completed ? 'completed' : ''}"
            data-task-id="${task.id}">
          <ytz-toggle
            ${task.completed ? 'checked' : ''}
            class="toggle-demo"
            aria-label="${task.completed ? 'Mark incomplete' : 'Mark complete'}"
            data-action="toggle"
          ></ytz-toggle>

          <div class="flex-grow-1">
            <span class="task-text db mb1">${escapeHtml(task.text)}</span>
            <span class="category-badge category-${task.category}">${task.category}</span>
          </div>

          <ytz-menu>
            <button slot="trigger" class="pa2 bg-transparent bn pointer br2 hover-bg-light-gray" aria-label="Task options">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path d="M8 4a1.5 1.5 0 110-3 1.5 1.5 0 010 3zM8 9.5a1.5 1.5 0 110-3 1.5 1.5 0 010 3zM8 15a1.5 1.5 0 110-3 1.5 1.5 0 010 3z"/>
              </svg>
            </button>
            <ytz-menuitem class="menu-item" value="edit">Edit</ytz-menuitem>
            <ytz-menuitem class="menu-item dark-red" value="delete">Delete</ytz-menuitem>
          </ytz-menu>
        </li>
      `).join('');

      // Attach event listeners to new elements
      attachTaskEventListeners();
    }

    function renderStats() {
      const stats = AppState.getStats();
      document.getElementById('stat-total').textContent = stats.total;
      document.getElementById('stat-active').textContent = stats.active;
      document.getElementById('stat-completed').textContent = stats.completed;
    }

    function updateSearchSuggestions() {
      const searchEl = document.getElementById('task-search');
      const tasks = AppState.tasks;

      // Clear existing options
      searchEl.querySelectorAll('ytz-option').forEach(opt => opt.remove());

      // Add options for each task
      tasks.forEach(task => {
        const option = document.createElement('ytz-option');
        option.value = task.text;
        option.textContent = task.text;
        searchEl.appendChild(option);
      });
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ==========================================
    // Event Handlers
    // ==========================================
    function attachTaskEventListeners() {
      // Toggle completion
      document.querySelectorAll('[data-action="toggle"]').forEach(toggle => {
        toggle.addEventListener('click', (e) => {
          const taskId = Number(e.target.closest('[data-task-id]').dataset.taskId);
          AppState.toggleTask(taskId);
        });
      });

      // Task menu actions
      document.querySelectorAll('#task-list ytz-menu').forEach(menu => {
        menu.addEventListener('select', (e) => {
          const taskId = Number(menu.closest('[data-task-id]').dataset.taskId);
          const action = e.detail.value;

          if (action === 'edit') {
            openEditDialog(taskId);
          } else if (action === 'delete') {
            confirmDelete(taskId);
          }
        });
      });
    }

    function openEditDialog(taskId) {
      const task = AppState.tasks.find(t => t.id === taskId);
      if (!task) return;

      const form = document.getElementById('edit-task-form');
      form.querySelector('[name="id"]').value = task.id;
      form.querySelector('[name="text"]').value = task.text;
      document.getElementById('edit-category').value = task.category;
      document.getElementById('edit-priority').value = task.priority;

      document.getElementById('edit-task-dialog').showModal();
    }

    let pendingDeleteId = null;

    function confirmDelete(taskId) {
      pendingDeleteId = taskId;
      const task = AppState.tasks.find(t => t.id === taskId);
      document.getElementById('delete-confirm-message').textContent =
        `Are you sure you want to delete "${task?.text}"? This action cannot be undone.`;
      document.getElementById('delete-confirm-dialog').showModal();
    }

    // ==========================================
    // Initialize App
    // ==========================================
    function init() {
      // Initial render
      renderTaskList();
      renderStats();
      updateSearchSuggestions();

      // Listen for state changes
      document.addEventListener('state:change', () => {
        renderTaskList();
        renderStats();
        updateSearchSuggestions();
      });

      // Filter event listeners
      document.getElementById('filter-status').addEventListener('change', (e) => {
        AppState.setFilter('status', e.detail.value);
      });

      document.getElementById('filter-category').addEventListener('change', (e) => {
        AppState.setFilter('category', e.detail.value);
      });

      document.getElementById('filter-priority').addEventListener('change', (e) => {
        AppState.setFilter('priority', e.detail.value);
      });

      // Search
      document.getElementById('task-search').addEventListener('change', (e) => {
        AppState.setFilter('search', e.detail.value || '');
      });

      // Add task form
      document.getElementById('add-task-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const form = e.target;
        const text = form.querySelector('[name="text"]').value.trim();

        if (text) {
          AppState.addTask({
            text,
            category: document.getElementById('add-category').value,
            priority: document.getElementById('add-priority').value
          });

          form.reset();
          document.getElementById('add-category').value = 'personal';
          document.getElementById('add-priority').value = 'medium';
          document.getElementById('add-task-dialog').close();
        }
      });

      // Edit task form
      document.getElementById('edit-task-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const form = e.target;
        const id = Number(form.querySelector('[name="id"]').value);
        const text = form.querySelector('[name="text"]').value.trim();

        if (text && id) {
          AppState.updateTask(id, {
            text,
            category: document.getElementById('edit-category').value,
            priority: document.getElementById('edit-priority').value
          });

          document.getElementById('edit-task-dialog').close();
        }
      });

      // Delete confirmation
      document.getElementById('delete-confirm-dialog').addEventListener('close', (e) => {
        if (e.target.returnValue === 'confirm' && pendingDeleteId) {
          AppState.deleteTask(pendingDeleteId);
        }
        pendingDeleteId = null;
      });

      // Actions menu
      document.querySelector('.flex-wrap ytz-menu').addEventListener('select', (e) => {
        const action = e.detail.value;

        if (action === 'clear-completed') {
          AppState.clearCompleted();
        } else if (action === 'export') {
          exportTasks();
        } else if (action === 'import') {
          importTasks();
        }
      });

      // Navigation drawer
      document.getElementById('nav-drawer').addEventListener('click', (e) => {
        const viewLink = e.target.closest('[data-view]');
        const categoryLink = e.target.closest('[data-category]');

        if (viewLink) {
          e.preventDefault();
          AppState.setFilter('status', viewLink.dataset.view);
          document.getElementById('filter-status').value = viewLink.dataset.view;
          document.getElementById('nav-drawer').close();
        }

        if (categoryLink) {
          e.preventDefault();
          AppState.setFilter('category', categoryLink.dataset.category);
          document.getElementById('filter-category').value = categoryLink.dataset.category;
          document.getElementById('nav-drawer').close();
        }
      });

      console.log('Vanilla JS Task Manager initialized');
    }

    // Export/Import functions
    function exportTasks() {
      const data = JSON.stringify(AppState.tasks, null, 2);
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'tasks.json';
      a.click();
      URL.revokeObjectURL(url);
    }

    function importTasks() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'application/json';
      input.onchange = async (e) => {
        const file = e.target.files[0];
        if (file) {
          try {
            const text = await file.text();
            const tasks = JSON.parse(text);
            if (Array.isArray(tasks)) {
              AppState.tasks = tasks;
              AppState.save();
              AppState.notify();
            }
          } catch (err) {
            console.error('Failed to import tasks:', err);
            alert('Failed to import tasks. Please check the file format.');
          }
        }
      };
      input.click();
    }

    // Initialize when components are ready
    customElements.whenDefined('ytz-dialog').then(init);
  </script>
</body>
</html>
